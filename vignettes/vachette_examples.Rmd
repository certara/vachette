---
title: "Vachette Examples"
output: rmarkdown::html_vignette
resource_files:
  - img/readme-plots-1.png
  - img/readme-plots-2.png
  - img/readme-plots-3.png
  - img/readme-plots-4.png
  - img/readme-plots-5.png
  - img/readme-plots-6.png

vignette: >
  %\VignetteIndexEntry{Vachette Examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Setup

## Installation

```{r install_vachette, eval=FALSE}
install.packages("vachette")
```

## Load Libraries

```{r, warning=FALSE, message=FALSE}
library(vachette)
library(tidyvpc)
library(ggplot2)
library(tidyverse)
```

```{r, echo=FALSE}
#Create theme for optimal vpc display in Rmd
rmd_theme <- theme(
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 6),
          legend.spacing=unit(.09, "cm"),
          legend.direction = "horizontal",
          legend.key.size = unit(.45, "cm")
)

theme_set(rmd_theme)

```

# Examples

## Intravenous

### Import Data

Data files:

* iv-obs.csv
* iv-typ.csv
* iv-vpc.csv

```{r}
obs <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/iv-obs.csv")
typ <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/iv-typ-minmax.csv")
sim <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/iv-sim.csv")

```

### Vachette Transformations

Generate transformations for `obs.data` and `sim.data`

```{r}
vd <-
  vachette_data(
    obs.data = obs,
    typ.data = typ,
    sim.data = sim,
    covariates = c(WT=70),
    mappings = c(x = "time",
                 OBS = "DV"),
    model.name  = "intravenous"
  ) |>
  apply_transformations()

```

### Vachette Plot

```{r}
p.obs.ref.query(vd) 

p.vachette(vd)

p.scaled.typical.full.curves.landmarks(vd)

p.scaling.factor(vd)

p.scaled.typical.curves(vd)

p.obs.excluded(vd)

vd$obs.excluded
```

### VPC

Extract obs.all and sim.all with vachette transformations

```{r}
obs_trans <- vd$obs.all
sim_trans <- vd$sim.all
```

Generate traditional and vachette transformed VPC's

```{r, fig.height=5}
vpc <- observed(obs_trans, x = x, y = y) |>
  simulated(sim_trans, x = x, y = y) |>
  binning(bin = "centers",
          centers = c(0.25, 0.5, 1, 2, 3, 4, 8, 12)) |>
  vpcstats()

pcvpc <- observed(obs_trans, x = x, y = y) |>
  simulated(sim_trans, x = x, y = y) |>
  binning(bin = "centers",
          centers = c(0.25, 0.5, 1, 2, 3, 4, 8, 12)) |>
  predcorrect(pred = PRED) |>
  vpcstats()

vpc_vachette <- observed(obs_trans, x = x.scaled, y = y.scaled) |>
  simulated(sim_trans, x = x.scaled, y = y.scaled) |>
  binning(bin = "centers",
          centers = c(0.25, 0.5, 1, 2, 3, 4, 8, 12))  |>
  vpcstats()


plot(vpc) + labs(title = "Traditional VPC",
                 x = "Time", y = "Concentration")

plot(pcvpc) + labs(title = "pcVPC",
                   x = "Time", y = "Concentration")

plot(vpc_vachette) + labs(title = "Vachette Transformed VPC",
                          x = "Time", y = "Concentration")  


```

## Sigmoid

### Import Data

Data files:

* sigmoid-obs.csv
* sigmoid-typ-minmax.csv
* sigmoid-sim.csv

```{r}
obs <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/sigmoid-obs.csv")
typ <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/sigmoid-typ-minmax.csv")
sim <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/sigmoid-sim.csv")

```

### Vachette Transformations

Generate transformations for obs.data

```{r}
vd <-
  vachette_data(
    obs.data = obs,
    typ.data = typ,
    sim.data = sim,
    covariates = c(WT=70),
    log.x = TRUE,
    mappings = c(x = "bmx",
                 OBS = "DV"),
    model.name  = "sigmoid"
  ) |>
  apply_transformations()

```

```{r v2acher, echo = FALSE}
vd$obs.all <- vd$obs.all %>% 
    mutate(x.vacher = ifelse(WT==70,x,x/(10/1)))

```

### Vachette Plot

```{r}
p.obs.ref.query(vd)

p.vachette(vd) 

p.scaled.typical.full.curves.landmarks(vd) 

p.scaling.factor(vd)

p.scaled.typical.curves(vd) 

geomadd <- function(.x) {
  .x + coord_cartesian(xlim = c(min(vd$obs.all$x.scaled), vd$xstop)) + scale_x_log10(limits = c(min(vd$obs.all$x.scaled), vd$xstop))
}

plot(
  p.vachette(vd) +
    geom_point(
      data = vd$obs.all[vd$obs.all$WT != 30, ],
      aes(x = x.vacher, y = y.scaled, fill = "V2ACHER"),
      pch = 1,
      size = 4
    ) +
    labs(fill = "",
         x = "ln(Biomarker Concentration)",
         y = "Response") +
    scale_fill_manual(values = "blue", labels = c(expression(
      paste("V" ^ 2 * "ACHER")
    )))
)
```

### VPC

Extract obs.all and sim.all with vachette transformations

```{r}
obs_trans <- vd$obs.all
sim_trans <- vd$sim.all
```

Generate traditional and vachette transformed VPC's

```{r, fig.height=5}
vpc <- observed(obs_trans, x = exp(x), y = y) |>
  simulated(sim_trans, x = exp(x), y = y) |>
  binning(bin = "centers",
          centers = c(0.003, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30, 100, 300)) |>
  vpcstats()

pcvpc <- observed(obs_trans, x = exp(x), y = y) |>
  simulated(sim_trans, x = exp(x), y = y) |>
  binning(bin = "centers",
          centers = c(0.003, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30, 100, 300)) |>
  predcorrect(pred = PRED) |>
  vpcstats()

vpc_vachette <- observed(obs_trans, x = exp(x.scaled), y = y.scaled) |>
  simulated(sim_trans, x = exp(x.scaled), y = y.scaled) |>
  binning(bin = "centers",
          centers = c(0.003, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30, 100, 300))  |>
  vpcstats()


plot(vpc) + labs(title = "Traditional VPC",
                 x = "Biomarker Concentration",
                 y = "Response")  +
  scale_x_log10()

plot(pcvpc) + labs(title = "pcVPC",
                   x = "Biomarker Concentration",
                   y = "Response")  +
  scale_x_log10()

plot(vpc_vachette) + labs(title = "Vachette Transformed VPC",
                          x = "Biomarker Concentration",
                          y = "Response")  +
  scale_x_log10()

```

## Oral-Absorption

### Import Data

Data files:

* oral-absorption-obs.csv
* oral-absorption-typ-minmax.csv
* oral-absorption-sim.csv

```{r}
obs <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/oral-absorption-obs.csv")
typ <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/oral-absorption-typ-minmax.csv")
sim <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/oral-absorption-sim.csv")
```

### Vachette Transformations

Generate transformations for obs.data and sim.data

```{r}
vd <-
  vachette_data(
    obs.data = obs,
    typ.data = typ,
    sim.data = sim,
    covariates = c(WT=70),
    mappings = c(x = "time",
                 OBS = "DV"),
    model.name  = "oral-absorption"
  ) |>
  apply_transformations()

```

### Vachette Plot

```{r}
p.obs.ref.query(vd)

p.scaled.typical.curves(vd)

p.prop.distances(vd)

p.scaled.typical.full.curves.landmarks(vd)

p.scaling.factor(vd)

p.vachette(vd)
```

### VPC

Extract obs.all and sim.all data from `vachette_data` object with vachette transformations

```{r}
obs_trans <- vd$obs.all
sim_trans <- vd$sim.all

```

Generate traditional and vachette transformed VPC's

```{r, fig.height=5}
vpc <- observed(obs_trans, x=x, y=y) |>
                  simulated(sim_trans, x=x, y=y) |>
                  binning(bin = "pam", nbins = 11) |>
                  vpcstats()

pcvpc <- observed(obs_trans, x=x, y=y) |>
                  simulated(sim_trans, x=x, y=y) |>
                  binning(bin = "pam", nbins = 11) |>
                  predcorrect(pred=PRED) |>
                  vpcstats()
 
vpc_vachette <- observed(obs_trans, x = x.scaled, y = y.scaled) |>
  simulated(sim_trans, x = x.scaled, y = y.scaled) |>
  binning(bin = "pam", nbins = 11) |>
  vpcstats()


plot(vpc) + labs(title = "Traditional VPC",
                 x = "Time", y = "Concentration")

plot(pcvpc) + labs(title = "pcVPC",
                   x = "Time", y = "Concentration")

plot(vpc_vachette) + labs(title = "Vachette Transformed VPC",
                          x = "Time", y = "Concentration") 

```


## Indirect Response

### Import Data

Data files:

* indirect-response-obs.csv
* indirect-response-typ-minmax.csv
* indirect-response-vpc.csv

```{r}
obs <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/indirect-response-obs.csv")
typ <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/indirect-response-typ-minmax.csv")
sim <- read.csv("https://certara-training.s3.amazonaws.com/Vachette/examples/examples/indirect-response-sim.csv")

```


### Vachette Transformations 

Generate transformations for obs.data

```{r}
vd <-
  vachette_data(
    obs.data = obs,
    typ.data = typ,
    sim.data = sim,
    covariates = c(WT=70),
    mappings = c(x = "time",
                 OBS = "DV"),
    model.name  = "indirect-response"
  ) |>
  apply_transformations(tol.noise = 1e-05)

```

### Vachette Plot

```{r}
addpoints <- vd$lm.all %>%
  filter(type %in% c("min", "inflec"))

p.obs.ref.query(vd) +
  geom_point(
    data = addpoints,
    aes(x = x, y = y, size = "Landmark"),
    shape = 3,
    stroke = 2
  ) +
  labs(size = "")

p.scaled.typical.full.curves.landmarks(vd)

p.scaling.factor(vd)

p.vachette(vd)
```

### VPC

Extract obs.all data from `vachette_data` object with vachette transformations from observed data

```{r}
obs_trans <- vd$obs.all
sim_trans <- vd$sim.all
```

Generate traditional and vachette transformed VPC's

```{r, fig.height=5}
vpc <- observed(obs_trans, x = x, y = y) |>
  simulated(sim_trans, x = x, y = y) |>
  binning(bin = "pam", nbins = 11) |>
  vpcstats()

pcvpc <- observed(obs_trans, x = x, y = y) |>
  simulated(sim_trans, x = x, y = y) |>
  binning(bin = "pam", nbins = 11) |>
  predcorrect(pred = PRED) |>
  vpcstats()

vpc_vachette <- observed(obs_trans, x = x.scaled, y = y.scaled) |>
  simulated(sim_trans, x = x.scaled, y = y.scaled) |>
  binning(bin = "pam", nbins = 11) |>
  vpcstats()



plot(vpc) + labs(title = "Traditional VPC",
                 x = "Time", y = "Response")
plot(pcvpc) + labs(title = "pcVPC",
                   x = "Time", y = "Response")
plot(vpc_vachette) + labs(title = "Vachette Transformed VPC",
                          x = "Time", y = "Response") 

```
